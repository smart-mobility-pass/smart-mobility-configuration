server.port=8765

eureka.client.service-url.defaultZone=http://eureka-server:8761/eureka/
eureka.instance.prefer-ip-address=true
eureka.instance.instance-id=${spring.cloud.client.ip-address}:${spring.application.name}:${server.port}

# -----------------------------------------------------------------------
# Discovery Locator DÉSACTIVÉ : on utilise uniquement les routes manuelles
# ci-dessous pour éviter les conflits de double-routing et garder le
# contrôle total sur les filtres (ex: RemoveRequestHeader sécurisé).
# -----------------------------------------------------------------------
spring.cloud.gateway.discovery.locator.enabled=false

spring.security.oauth2.resourceserver.jwt.issuer-uri=http://keycloak:8080/realms/smart-mobility

# =======================================================================
# Routes configuration
# NOTE : Les headers X-User-* sont nettoyés en amont par AuthenticationFilter
# (GlobalFilter order=-100). Ces headers sont systématiquement supprimés des
# requêtes ENTRANTES, puis ré-injectés uniquement depuis le JWT validé.
# =======================================================================

# 0. Keycloak - Route publique (POST /auth/** → Keycloak sans validation JWT)
# Permet aux clients de s'authentifier via le Gateway sans appel direct à Keycloak.
spring.cloud.gateway.routes[0].id=keycloak-auth
spring.cloud.gateway.routes[0].uri=http://keycloak:8080
spring.cloud.gateway.routes[0].predicates[0]=Path=/auth/**
spring.cloud.gateway.routes[0].filters[0]=RewritePath=/auth/(?<segment>.*), /$\{segment}

# 1. User Mobility Pass Service (User, Passes, Subscriptions)
spring.cloud.gateway.routes[1].id=user-service
spring.cloud.gateway.routes[1].uri=lb://user-mobility-pass-service
spring.cloud.gateway.routes[1].predicates[0]=Path=/api/users/**, /api/passes/**, /api/subscriptions/**

# 2. Billing Service (Accounts) - Map /api/billing to /accounts
spring.cloud.gateway.routes[2].id=billing-service
spring.cloud.gateway.routes[2].uri=lb://billing-service
spring.cloud.gateway.routes[2].predicates[0]=Path=/api/billing/**
spring.cloud.gateway.routes[2].filters[0]=RewritePath=/api/billing/(?<segment>.*), /accounts/$\{segment}

# 3. Trip Management Service - Map /api/trips to /trips
spring.cloud.gateway.routes[3].id=trip-management-service
spring.cloud.gateway.routes[3].uri=lb://trip-management-service
spring.cloud.gateway.routes[3].predicates[0]=Path=/api/trips/**
spring.cloud.gateway.routes[3].filters[0]=RewritePath=/api/trips/(?<segment>.*), /trips/$\{segment}

# 4. Pricing Service (API publique)
spring.cloud.gateway.routes[4].id=pricing-service-api
spring.cloud.gateway.routes[4].uri=lb://pricing-discount-service
spring.cloud.gateway.routes[4].predicates[0]=Path=/api/pricing/**

# 5. Pricing Service (Admin)
spring.cloud.gateway.routes[5].id=pricing-service-admin
spring.cloud.gateway.routes[5].uri=lb://pricing-discount-service
spring.cloud.gateway.routes[5].predicates[0]=Path=/api/admin/**
spring.cloud.gateway.routes[5].filters[0]=RewritePath=/api/admin/(?<segment>.*), /admin/$\{segment}

# 6. Notification Service
spring.cloud.gateway.routes[6].id=notification-service
spring.cloud.gateway.routes[6].uri=lb://notification-service
spring.cloud.gateway.routes[6].predicates[0]=Path=/api/notifications/**

# =======================================================================
# Observabilité
# =======================================================================
management.tracing.sampling.probability=1.0
management.zipkin.tracing.endpoint=http://zipkin:9411/api/v2/spans
